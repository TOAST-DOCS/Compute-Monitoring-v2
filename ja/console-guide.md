## Compute > Monitoring V2 > コンソール使用ガイド


## 単一インスタンス状態照会(インスタンス管理ページで提供)

TOASTコンソールで**Compute > Instance > 管理**を選択します。 `照会するインスタンス`を選択します。画面下にある**モニタリング**タブで該当インスタンスのモニタリンググラフを照会できます。

> [通知]
> Monitoring V2サービス提供以前に作成されたインスタンスにこの機能を使用するには、該当インスタンスの**モニタリング**タブで提供されるインストールガイドに従ってエージェントをインストールする必要があります。<br>
> エージェントのインストール後、**モニタリングタブ**にグラフが表示されたら、その時点からMonitoring V2の機能を活用できます。

すべてのグラフは照会時点を基準に`直近1時間`のデータを表示し、自動アップデート機能はありません。
代わりにグラフ領域の左上にある**更新**ボタンをクリックすると、最新データを確認できます(手動アップデート機能)。

![CPU usage image <](http://static.toastoven.net/prod_infrastructure/monitoring/v2/image_001.jpg) 

各グラフの説明は次のとおりです。

| グラフ      | 指標説明        |
|:--------------|----------------|
|CPU使用率   | total：総CPU使用率(%)<br>sys：カーネルモードの作業に所要したCPU使用率(%)<br>usr：ユーザーモードの作業に所要したCPU使用率(%) |
|CPU平均負荷 | 1m：直近1分間にCPUを使用したプロセス数(待機状態含む)の平均<br>5m：直近5分間にCPUを使用したプロセス数(待機状態含む)の平均<br>15m：直近15分間にCPUを使用したプロセス数(待機状態含む)の平均<br><br> *[参考]この指標はLinuxインスタンス専用指標です。<br>(Windowsインスタンスは、グラフは表示されますがデータは提供されません。)* |
|メモリ使用率 | used：メモリ使用率(%)<br>swapused：スワップ使用率(%)<br><br>*[参考] Linuxインスタンスのメモリ使用率計算時、バッファおよびキャッシュ領域は使用可能な領域とみなし使用量に含めません。* |
|ディスク使用率  | io：ディスクデバイス使用率(%)<br> used：ディスクスペース使用率(%)<br><br>*[参考] ioおよびusedはマウント状態のファイルシステム(Windowsの場合、ディスクドライブ)ごとに提供されます。* |
|ディスク転送率   | read：ディスク読み込み転送率(Bps)<br>write：ディスク書き込み転送率(Bps)<br><br>*[参考] readおよびwriteは、マウント状態のファイルシステム(Windowsの場合ディスクドライブ)ごとに提供されます。*<br>*[参考] y軸の基本単位はBps(Bytes per Sec)で、値のサイズに応じて単位が変わります。* |
|ネットワーク転送率 | In：ネットワーク読み込み転送率(Bps)<br>Out：ネットワーク書き込み転送率(Bps)<br><br>*[参考] InおよびOutは、ネットワークデバイスごとに提供されます。*<br>*[参考] y軸の基本単位はBps(Bytes per Sec)で、値のサイズに応じてy軸の単位が変わります。* |




## 複数インスタンスの状態照会
**Server Details**タブ(下図)の各グラフでは、選択したインスタンスの指標を同時に確認できます。
![server details image<](http://static.toastoven.net/prod_infrastructure/monitoring/v2/image_002.jpg)

### 1.インスタンスリスト(矢印1領域)
エージェント起動履歴があるインスタンスのリストを確認できます。
> [参考]
> エージェント起動履歴があるが現在はエージェントが終了しているインスタンス、または終了状態のインスタンスも該当リストに含まれます。
> このようなインスタンスは、状態フィールド値が'inActive'と表示されます。

リストで選択されたインスタンスは、グラフに自動的に反映されます(複数選択可能)。

インスタンスリストからも、各インスタンスの基本情報およびリソース使用率(照会/アップデート時点基準)を確認できます。
>[参考]
> インスタンスリストのDisk Read、Disk Write値は、該当インスタンスのすべてのディスクに対して同一指標ごとに合算した値を表示します。
> インスタンスリストのNetwork RX、Network TX値は、該当インスタンスのすべてのネットワークデバイスに対して同一指標ごとに合算した値を表示します。

すべてのフィールドに対する検索機能を利用すると、希望する対象を簡単に選んで確認できます。

### 2.グラフ(矢印2領域)
**モニタリング**タブ同様に6個のグラフを提供しますが、ここで各グラフは選択されたすべてのインスタンスに対する指標を同時に提供します。

>[参考]
>次の2つのグラフは、**モニタリング**タブとは異なり、一部指標のみを提供します。<br>
>CPU Usageグラフ：各インスタンスのtotal使用率のみ提供
>Memory Usageグラフ：各インスタンスのmemory使用率(used)のみ提供

グラフの上にマウスオーバーすると、カーソルが指す時点(x軸)の指標値が表示されます。
また、マウスオーバーしていないグラフでも、同じ時点の指標値が一緒に表示されます(shared-tooltip機能)。

>[参考]
>選択したインスタンスの個数が多い場合、グラフの可読性が落ちる場合があります。

### 3.照会期間指定(矢印3領域)
グラフ照会期間を設定し、希望する時点のインスタンス状態を確認できます。
> [参考]
> グラフ照会可能時点は、現在を基準に`過去1年`までです。

| 設定項目 | 意味 |
| ---------- | ----- |
| 1 hour  | 現在基準で直近1時間のデータ照会 |
| 24 hour | 現在基準で直近1日間のデータ照会 |
| 1 week  | 現在基準で直近一週間のデータ照会 |
| 1 month | 現在基準で直近一か月のデータ照会 |
| Custom  | ユーザーが直接照会期間を指定(開始時点および終了時点) |

### 4.グラフアップデート周期設定(矢印4領域)
すべてのグラフで自動的に'更新'機能を使用できます。
off'に設定した場合は、グラフを'更新'しません。
off'ではない場合は、該当値に表示される時間周期でグラフが自動的に'更新'されません。

## アラームポリシー設定
**Alarm Setting**タブでは、アラームポリシーリストを照会し、アラームポリシーを作成、修正、削除できます。

![alarm policy<](http://static.toastoven.net/prod_infrastructure/monitoring/v2/image_003.jpg)

アラームポリシーは、インスタンス状態監視のための各種設定内容を含んでおり、これを基準にユーザーはインスタンス状態に応じたアラームを受け取れます。
>[参考]
>アラームを受け取るには、別途の[アラーム受信者および受信方法を設定](./console-guide/#_4)する必要があります。

Monitoring V2サービスでは、基本的に`Defaultポリシー`を提供します。このポリシーは修正できますが、削除はできません。
>[参考]
>モニタリングサービス登録(エージェントの最初の起動時に実行)直後のインスタンスにはDefaultポリシーが適用されます。
>インスタンスに適用するアラームポリシーは、いつでも変更できます。

>[注意]
>すべてのインスタンスは、1つのアラームポリシーにのみ含めることができます。
>アラームポリシーを削除すると、該当ポリシーの適用を受けたすべてのインスタンスは、どんなアラームポリシーにも属さない状態になります。

アラームポリシーで監視できる項目は次のとおりです。
![alarm configuration<](http://static.toastoven.net/prod_infrastructure/monitoring/v2/image_004.jpg)

>[参考]下記表の'設定項目'フィールド値説明<br>
> 使用するかどうか：該当項目を使用するかどうかの設定(on/off)<br>
> しきい値：該当項目のアラームの受信を希望する状態の最小値。warnおよびfatalの2段階で設定可能<br>
> Duration：該当項目の設定内容(使用するかどうか及びしきい値)に応じたイベント感知後、実際にアラームを送信するまでその状態が持続する必要がある時間(すなわち、その状態がDurationに指定された時間内に解消する場合は、アラームは発生しない)<br>

| 監視対象 | 設定項目 | 用途 | 説明 |
|-----------|-----------|------|------|
| 再起動 | 使用するかどうか | インスタンス再起動を監視 | インスタンス再起動が完了した時点でアラーム発生<br><br>*[参考]再起動アラーム送信後`10分以内の再起動`は無視(アラームを送信しない)* |
| No Data | 使用するかどうか<br>Duration |エージェントのデータ未転送状態監視 | データの未転送を最初に感知した後、 Durationに設定された時間、継続して該当状態が持続する場合にアラームを送信 |
| CPU | 使用するかどうか<br>しきい値(warn, fatal)<br>Duration(warn, fatal) | CPU使用率(%)監視 | 総CPU使用率に2段階(warn, fatal)でしきい値設定<br>設定されたしきい値に達した後、 Durationに指定された時間以降も該当状態が持続する時にアラームを送信 |
| メモリ | 使用するかどうか<br>しきい値(warn, fatal)<br>Duration(warn, fatal) | メモリ使用率(%)監視 | メモリ使用率に2段階(warn, fatal)でしきい値設定<br>設定されたしきい値に達した後、 Durationに指定された時間以降も該当状態が持続する時にアラームを送信 |
| Disk Quota | 使用するかどうか<br>しきい値(warn, fatal)<br>Duration(warn, fatal) | ディスクスペース使用率(%)監視 | ディスクスペース使用率に2段階(warn, fatal)でしきい値設定<br>設定されたしきい値に達した後、Durationに指定された時間以降にも該当状態が持続する時にアラームを送信<br><br>*[参考]ディスクが複数ある時、個別に適用される* |
| Network  | 使用するかどうか<br>しきい値(warn, fatal)<br>Duration(warn, fatal) | ネットワーク転送率(Bps)監視 | ネットワーク転送率に2段階(warn, fatal)でしきい値設定<br>設定されたしきい値に達した後、 Durationに指定された時間以降にも該当状態が持続する時にアラームを送信<br><br>*[参考]ネットワークデバイスが複数の時、個別に適用される*<br>*[参考]ここで設定されるしきい値は、個別ネットワークデバイスのNetwork RX + TX(全体送受信率の合計)を意味* |
| インスタンスリスト | 適用するかどうか | 該当ポリシーを適用するインスタンス指定 | 選択されたインスタンスに該当ポリシーベースの監視機能を使用する |


## アラーム受信設定
**Users**タブではアラーム受信者および受信方法を設定できます。

![alarm user<](http://static.toastoven.net/prod_infrastructure/monitoring/v2/image_005.jpg)

プロジェクトユーザーリストで、希望するユーザーに対するアラーム受信方式(メールまたは携帯電話)を選択した後、**申請**ボタンを押すと設定内容が保存されます。
以降は該当ユーザーに、指定された方式でアラームが送信されます。
アラームの受信を解除するには、同じ方式で設定内容を変更してください。

アラーム状況が感知されると、設定内容を元にアラームメッセージが送信されます。
また、最初のアラーム送信後、下記の基準で最大3回の追加アラームを送信できます。
(ただし、再起動感知アラームは、下記に該当しません。)

| 追加アラーム送信時点 | 説明 |
| ----------| -----|
| 10分後  | 最初のアラーム送信後、該当の状態が10分以上持続する場合 |
| 1時間後 | 最初のアラーム送信後、該当の状態が1時間(60分)以上持続する場合 |
| 1日後  | 最初のアラーム送信後、該当の状態が1日(1440分)以上持続する場合 |

>[参考] OKアラーム送信
> インスタンスの状態が正常化すると、これを知らせるOKアラームが1回送信されます。


## アラーム履歴照会
**Alarm Logs**タブでアラーム履歴を照会できます。
各アラーム履歴は、アラームを最初に送信した時に作成されます。

![alarm logs image<](http://static.toastoven.net/prod_infrastructure/monitoring/v2/image_006.jpg)

アラーム履歴は、次のような項目で構成されます。

| 項目       | 説明 |
|--------------|-----------|
| Server名 | アラームが発生したインスタンス名 |
| IPアドレス | インスタンスのIPアドレス |
| 日付       | アラームが送信された時刻 |
| 計量        | アラームが発生した指標 |
| イベント感知 | アラーム発生時点の指標値 |
| しきい値     | 該当指標に設定されたしきい値 |
| アラーム送信 | アラームを送信するかどうか |

インスタンス名やIPアドレスで検索して、希望するインスタンスの履歴を確認できます。
また期間設定ボタンを使用して、希望する時点の履歴を確認することもできます。

> [参考]
> アラーム履歴照会可能時点は、過去1年までです。

| ボタン  | 説明 |
|---------|-----------|
| 1日  | 直近1日のアラーム履歴照会 |
| 1週 | 直近一週間のアラーム履歴照会 |
| 1月 | 直近一ヶ月間のアラーム履歴照会 |
| 指定 | ユーザーが直接照会時点を指定(開始時点および終了時点) |


## モニタリングエージェント参考事項
| 項目 | 説明 |
| -----| -----|
| データ収集周期 | モニタリングエージェントは、1分周期でデータを収集して転送します。 |
| ネットワーク - ポート設定 | エージェントの正常動作のためには、TCP送信(egress)ポート80と6600がセキュリティーグループで許可されている必要があります。<br>TOAST Computeサービスで提供する基本セキュリティーグループ(default security group)をそのまま使用する時は、エージェント動作に問題がありません。<br>[注意]セキュリティーグループを修正してTCP送信(egress)ポートを直接操作する場合、80と6600ポートを許可する必要があります。 |
| ネットワーク - インターネットゲートウェイ設定 | モニタリングエージェントが収集したデータを収集サーバーに転送するには、インターネットゲートウェイが必要です。<br> TOAST Networkサービスの基本設定に従えば、エージェント動作に問題がありません。<br>インターネットゲートウェイを削除すると、該当ネットワークに接続されたインスタンスのモニタリング機能を使用できません。 |
| エージェントプロセス強制終了 | 起動中のエージェントプロセスを中断すると、Monitoring V2の機能を正常に使用できなくなります。 |

Monitoring V2サービスを正常に使用できない場合は、[TOASTサポート](https://www.toast.com/support)までお問い合わせください。
